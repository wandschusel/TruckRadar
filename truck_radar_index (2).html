<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>TruckRadar</title>
<style>
:root{--bg:#f7f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--primary:#2563eb;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--chip:#eef2ff;--line:#e5e7eb;--shadow:0 6px 24px rgba(0,0,0,.08)}
html[data-theme="dark"]{--bg:#0b1020;--fg:#e5e7eb;--muted:#94a3b8;--card:#0f172a;--primary:#60a5fa;--chip:#0b1c3a;--line:#1f2937;--shadow:0 12px 32px rgba(0,0,0,.4)}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:500 14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
button,input,select{font:inherit;color:inherit}
header{position:fixed;inset:0 0 auto 0;display:grid;gap:.5rem;grid-template-columns:1fr auto auto auto auto;align-items:center;background:var(--card);padding:.6rem .8rem;border-bottom:1px solid var(--line);z-index:40}
#title{font-weight:800}
input[type="text"],input[type="number"]{background:var(--bg);border:1px solid var(--line);border-radius:.7rem;padding:.6rem .7rem;width:100%}
label.small{font-size:.8em;color:var(--muted)}
.btn{background:var(--primary);color:#fff;border:none;border-radius:.7rem;padding:.6rem .8rem;cursor:pointer;box-shadow:var(--shadow)}
.btn.sec{background:transparent;color:var(--primary);border:1px solid var(--primary)}
.btn.ghost{background:transparent;color:var(--fg);border:1px solid var(--line)}
.btn:focus,.chip:focus{outline:2px solid var(--primary);outline-offset:2px}
#app{display:grid;grid-template-columns:280px 1fr;gap:0;height:100dvh}
#sidebar{position:fixed;top:56px;bottom:86px;left:0;width:280px;background:var(--card);border-right:1px solid var(--line);padding:.8rem;overflow:auto;z-index:30}
#main{position:fixed;top:56px;bottom:86px;left:280px;right:0}
@media(max-width:900px){#app{grid-template-columns:1fr}#sidebar{transform:translateX(-100%);transition:transform .18s ease;box-shadow:var(--shadow)}#sidebar.open{transform:translateX(0)}#main{left:0}}
.section{margin:.8rem 0}
.chips{display:flex;flex-wrap:wrap;gap:.4rem}
.chip{padding:.4rem .6rem;border-radius:999px;background:var(--chip);border:1px solid var(--line);cursor:pointer}
.chip.active{background:var(--primary);color:#fff;border-color:transparent}
.range{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
.stat{font-size:.86em;color:var(--muted)}
#map{position:absolute;inset:0;background:#9cc0e6;touch-action:none}
#tiles,#overlay{position:absolute;inset:0;overflow:hidden}
.tile{position:absolute;width:256px;height:256px;image-rendering:pixelated}
.marker{position:absolute;transform:translate(-50%,-100%);border-radius:10px;padding:.2rem .35rem;font-weight:800;font-size:.78em;color:#fff;box-shadow:var(--shadow);cursor:pointer}
.mok{background:var(--ok)}.mwr{background:var(--warn)}.mbd{background:var(--bad)}.mcl{background:#334155}
#poly{position:absolute;inset:0;pointer-events:none}
#popup{position:fixed;left:50%;bottom:98px;transform:translateX(-50%);background:var(--card);border:1px solid var(--line);border-radius:1rem;min-width:280px;max-width:min(92vw,520px);padding:.8rem;box-shadow:var(--shadow);z-index:35;display:none}
.row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.fac svg{width:18px;height:18px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:.3rem .6rem;align-items:center}
#sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--line);padding:.6rem .8rem;z-index:39;max-height:86px;overflow:hidden;transition:max-height .18s ease}
#sheet.open{max-height:60vh}
.list .item{display:grid;grid-template-columns:1fr auto;gap:.3rem;padding:.5rem;border:1px solid var(--line);border-radius:.7rem;margin:.3rem 0}
.badge{font:700 .78em/1.1 system-ui;padding:.2rem .4rem;border-radius:.4rem}
.green{background:rgba(16,185,129,.15);color:#10b981}.yellow{background:rgba(245,158,11,.18);color:#f59e0b}.red{background:rgba(239,68,68,.15);color:#ef4444}
#zoomCtl{position:fixed;right:.6rem;bottom:180px;display:grid;gap:.4rem;z-index:38}
#zoomCtl button{width:40px;height:40px;border-radius:.7rem}
#toast{position:fixed;right:.8rem;bottom:95px;background:var(--fg);color:var(--bg);padding:.5rem .7rem;border-radius:.6rem;display:none;z-index:42}
#timer{position:fixed;right:.8rem;top:66px;background:var(--card);border:1px solid var(--line);padding:.5rem;border-radius:.7rem;display:grid;gap:.4rem;z-index:38}
footer{position:fixed;left:.6rem;bottom:66px;color:var(--muted);font-size:.8em}
.toggle{appearance:none;width:36px;height:22px;border-radius:22px;background:var(--line);position:relative;outline:none;cursor:pointer;border:none}
.toggle:checked{background:var(--primary)}
.toggle::after{content:"";position:absolute;width:16px;height:16px;border-radius:999px;top:3px;left:4px;background:#fff;transition:left .18s}
.toggle:checked::after{left:16px}
hr{border:none;border-top:1px solid var(--line);margin:.5rem 0}
.k{color:var(--muted)}
.hidden{display:none}
.smallnote{font-size:.75em;color:var(--muted)}
</style>
</head>
<body>
<header>
<div id="title" aria-label="TruckRadar">üöö TruckRadar</div>
<input id="dest" type="text" placeholder="Ziel eingeben (Stadt, Adresse, Koord.)" aria-label="Ziel eingeben"/>
<div class="row" aria-label="Truck Filter">
<label class="small">H√∂he(m)<input id="tH" type="number" step="0.1" min="2" max="5" value="4.0" style="width:72px"></label>
<label class="small">Gew.(t)<input id="tW" type="number" step="0.5" min="3" max="40" value="18" style="width:72px"></label>
<label class="small">ADR <input id="tADR" type="checkbox" class="toggle" aria-label="ADR"></label>
</div>
<button id="plan" class="btn" aria-label="Route planen">Route planen</button>
<button id="along" class="btn sec" aria-label="Spots entlang Route">Spots entlang Route</button>
<button id="theme" class="btn ghost" aria-label="Dark Mode">‚òæ</button>
<button id="menu" class="btn ghost" aria-label="Seitenleiste">‚ò∞</button>
</header>
<div id="app">
<aside id="sidebar" aria-label="Filter und Optionen">
<div class="section"><b>Filter</b><div class="chips" id="chips"></div></div>
<div class="section range"><label>Max-H√∂he (m)</label><input id="fH" type="range" min="2" max="5" step="0.1" value="4.0"></div>
<div class="section range"><label>Min. Security (0‚Äì3)</label><input id="fS" type="range" min="0" max="3" step="1" value="0"></div>
<div class="section"><label><input id="onlyRoute" type="checkbox"> Nur Spots &lt; 2 km von Route</label></div>
<div class="section stat" id="stats">Sichtbare Spots: ‚Äì ¬∑ √ò Prognose: ‚Äì</div>
<hr/>
<div class="section"><b>Pausen-Timer</b>
<div class="row">
<button class="btn ghost" data-tpreset="45">45min</button>
<button class="btn ghost" data-tpreset="15">15min</button>
<button class="btn ghost" id="tstart">Start</button>
<button class="btn ghost" id="tstop">Stop</button>
<button class="btn ghost" id="treset">Reset</button>
</div>
<div id="tleft" class="stat">‚Äì:‚Äì</div>
</div>
<p class="smallnote">Kilometer sind Stra√üen‚ÄëSch√§tzung (Luftlinie √ó 1.25).</p>
</aside>
<main id="main">
<div id="map" role="application" aria-label="Karte">
<div id="tiles"></div>
<svg id="poly"></svg>
<div id="overlay"></div>
</div>
</main>
</div>
<div id="zoomCtl" aria-label="Zoom Steuerung">
<button id="zin" class="btn" title="Reinzoomen" aria-label="Reinzoomen">Ôºã</button>
<button id="zout" class="btn" title="Rauszoomen" aria-label="Rauszoomen">Ôºç</button>
</div>
<div id="popup" role="dialog" aria-modal="true"></div>
<div id="sheet" aria-label="Top Spots">
<div class="row" style="justify-content:space-between">
<b>Top 3 Stopps entlang der Route</b>
<button id="more" class="btn ghost">Mehr anzeigen</button>
</div>
<div id="toplist" class="list"></div>
</div>
<div id="toast"></div>
<div id="timer" class="hidden"><div><b>Timer</b></div><div id="timerTxt">‚Äì</div></div>
<footer>Prognosen ohne Gew√§hr. Beachte Beschilderung vor Ort. Kartendaten ¬© OpenStreetMap-Mitwirkende.</footer>

<script type="application/json" id="spots">[
{"id":"s1","name":"Freiburg-Nord","lat":48.055,"lng":7.85,"facilities":["wc","food","fuel","lighting"],"security_level":2,"max_height":4.2},
{"id":"s2","name":"March S√ºd","lat":48.08,"lng":7.79,"facilities":["wc","lighting"],"security_level":1,"max_height":4.0},
{"id":"s3","name":"Teningen Ost","lat":48.12,"lng":7.82,"facilities":["wc","shower","food","lighting"],"security_level":2,"max_height":4.2},
{"id":"s4","name":"Emmendingen","lat":48.13,"lng":7.85,"facilities":["wc","security","lighting"],"security_level":3,"max_height":4.5},
{"id":"s5","name":"Riegel A5","lat":48.15,"lng":7.75,"facilities":["wc","food"],"security_level":1,"max_height":4.0},
{"id":"s6","name":"Herbolzheim","lat":48.21,"lng":7.8,"facilities":["wc","fuel","lighting"],"security_level":2,"max_height":4.3},
{"id":"s7","name":"Kenzingen","lat":48.2,"lng":7.81,"facilities":["wc","shower","food"],"security_level":1,"max_height":4.1},
{"id":"s8","name":"Rust Park","lat":48.27,"lng":7.72,"facilities":["wc","food","lighting"],"security_level":1,"max_height":4.2},
{"id":"s9","name":"Orschweier","lat":48.3,"lng":7.87,"facilities":["wc","security","lighting"],"security_level":2,"max_height":4.4},
{"id":"s10","name":"Lahr West","lat":48.34,"lng":7.86,"facilities":["wc","shower","food","fuel","lighting"],"security_level":2,"max_height":4.5},
{"id":"s11","name":"Friesenheim","lat":48.37,"lng":7.9,"facilities":["wc","lighting"],"security_level":1,"max_height":4.2},
{"id":"s12","name":"Offenburg S√ºd","lat":48.44,"lng":7.94,"facilities":["wc","food","fuel","lighting"],"security_level":2,"max_height":4.3},
{"id":"s13","name":"Appenweier","lat":48.52,"lng":7.98,"facilities":["wc","security","lighting"],"security_level":3,"max_height":4.5},
{"id":"s14","name":"Renchen","lat":48.57,"lng":8.02,"facilities":["wc","food"],"security_level":1,"max_height":4.1},
{"id":"s15","name":"Achern","lat":48.63,"lng":8.04,"facilities":["wc","shower","lighting"],"security_level":2,"max_height":4.3},
{"id":"s16","name":"B√ºhl","lat":48.7,"lng":8.1,"facilities":["wc","food","fuel"],"security_level":2,"max_height":4.4},
{"id":"s17","name":"Ottersweier","lat":48.69,"lng":8.06,"facilities":["wc","lighting"],"security_level":1,"max_height":4.0},
{"id":"s18","name":"Baden-Baden Nord","lat":48.77,"lng":8.16,"facilities":["wc","security","shower","lighting"],"security_level":3,"max_height":4.6},
{"id":"s19","name":"Sinzheim","lat":48.75,"lng":8.15,"facilities":["wc","food"],"security_level":1,"max_height":4.1},
{"id":"s20","name":"H√ºgelsheim","lat":48.8,"lng":8.13,"facilities":["wc","fuel","lighting"],"security_level":2,"max_height":4.3},
{"id":"s21","name":"Rastatt","lat":48.86,"lng":8.21,"facilities":["wc","lighting","security"],"security_level":2,"max_height":4.5},
{"id":"s22","name":"√ñtigheim","lat":48.9,"lng":8.24,"facilities":["wc","food"],"security_level":1,"max_height":4.0},
{"id":"s23","name":"Bietigheim","lat":48.95,"lng":8.27,"facilities":["wc","shower","lighting"],"security_level":2,"max_height":4.2},
{"id":"s24","name":"Muggensturm","lat":48.92,"lng":8.29,"facilities":["wc","fuel","lighting"],"security_level":2,"max_height":4.3},
{"id":"s25","name":"Malsch","lat":49.02,"lng":8.33,"facilities":["wc","food","lighting"],"security_level":1,"max_height":4.2},
{"id":"s26","name":"Ettlingen","lat":49.05,"lng":8.4,"facilities":["wc","security","lighting"],"security_level":3,"max_height":4.6},
{"id":"s27","name":"Karlsruhe-S√ºd","lat":49.06,"lng":8.45,"facilities":["wc","food","fuel","lighting"],"security_level":2,"max_height":4.5},
{"id":"s28","name":"Karlsruhe-West","lat":49.03,"lng":8.39,"facilities":["wc","lighting"],"security_level":1,"max_height":4.1}
]</script>
<script>
(function(){
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const API='/.netlify/functions/reports';
const ROAD_FACTOR=1.25; const road=km=>km*ROAD_FACTOR;
const state={center:{lat:48.34,lng:7.86},zoom:11,route:null,pos:null,filters:{fac:new Set(),maxH:4,minSec:0,onlyRoute:false},truck:{h:4,w:18,adr:false},reports:[],speedKmh:70,offline:false,fullList:false};
const facilities=["wc","shower","security","food","fuel","lighting"];
const SVGs={wc:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 7h2v2H7v8H5V9H3V7h4zm12 0v2h-2v8h-2V9h-2V7h6z"/></svg>',shower:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13 5a5 5 0 0 0-5 5v8H6V10a7 7 0 1 1 14 0v8h-2v-8a5 5 0 0 0-5-5z"/></svg>',security:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l8 4v6c0 5-3.5 9-8 10-4.5-1-8-5-8-10V6l8-4z"/></svg>',food:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h2v9H7V2zm4 0h2v5h1v6h-2V7h-1V2zm6 9h2v11h-2V11z"/></svg>',fuel:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 3h10v18H3V3zm14 2l4 4v10a3 3 0 0 1-6 0V9l2 2v8a1 1 0 1 0 2 0V10l-2-2V5z"/></svg>',lighting:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13 3L4 14h6l-2 7 9-11h-6l2-7z"/></svg>'};
const chipsEl=$('#chips'); facilities.forEach(f=>{const b=document.createElement('button'); b.className='chip'; b.role='switch'; b.ariaLabel=f; b.textContent=f; b.onclick=()=>{b.classList.toggle('active'); state.filters.fac.has(f)?state.filters.fac.delete(f):state.filters.fac.add(f); renderAll(); computeAlong();}; chipsEl.appendChild(b)});
const SPOTS=JSON.parse($('#spots').textContent);
(function genReports(){const now=Date.now(); for(let i=0;i<100;i++){const s=SPOTS[Math.floor(Math.random()*SPOTS.length)]; const age=Math.random()*24*3600*1000; const ts=new Date(now-age).toISOString(); const r=Math.random(); const status=r<.33?"empty":r<.77?"some":"full"; state.reports.push({spot_id:s.id,timestampISO:ts,status,reputation:Math.random()});}})();
try{const loc=JSON.parse(localStorage.getItem('tr_reports')||'[]'); if(loc.length) state.reports.push(...loc);}catch{}
(async function syncReports(){try{const r=await fetch(API); if(r.ok){const rows=await r.json(); rows.forEach(x=>state.reports.push({spot_id:x.spot_id,timestampISO:x.created_at,status:x.status,reputation:x.reputation??.5,note:x.note??''})); renderAll();}}catch{}})();

const mapEl=$('#map'), tilesEl=$('#tiles'), overlayEl=$('#overlay'), polyEl=$('#poly');
function tileUrl(z,x,y){const s=['a','b','c'][Math.abs(x+y)%3]; return `https://${s}.tile.openstreetmap.org/${z}/${x}/${y}.png`;}
function project(lat,lng,z){const pw=256*Math.pow(2,z); const x=(lng+180)/360*pw; const s=Math.sin(lat*Math.PI/180); const y=(.5-Math.log((1+s)/(1-s))/(4*Math.PI))*pw; return{x,y};}
function unproject(x,y,z){const pw=256*Math.pow(2,z); const lng=x/pw*360-180; const n=Math.PI-2*Math.PI*y/pw; const lat=180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n))); return{lat,lng};}
function renderTiles(){tilesEl.innerHTML=''; const {width,height}=mapEl.getBoundingClientRect(); const z=state.zoom; const c=project(state.center.lat,state.center.lng,z); const tlx=c.x-width/2,tly=c.y-height/2; const startX=Math.floor(tlx/256), startY=Math.floor(tly/256); const endX=Math.floor((c.x+width/2)/256), endY=Math.floor((c.y+height/2)/256); for(let x=startX-1;x<=endX+1;x++){ for(let y=startY-1;y<=endY+1;y++){const img=new Image(); img.draggable=false; img.src=tileUrl(z,x,y); img.className='tile'; img.style.left=(x*256-tlx)+'px'; img.style.top=(y*256-tly)+'px'; img.onerror=()=>{showToast('Offline? Tiles nicht geladen.'); state.offline=true}; tilesEl.appendChild(img); }} }
let dragging=false,last={x:0,y:0};
mapEl.addEventListener('mousedown',e=>{dragging=true; last={x:e.clientX,y:e.clientY}});
mapEl.addEventListener('mousemove',e=>{if(!dragging)return; const dx=e.clientX-last.x, dy=e.clientY-last.y; last={x:e.clientX,y:e.clientY}; const c=project(state.center.lat,state.center.lng,state.zoom); const nx=c.x-dx, ny=c.y-dy; state.center=unproject(nx,ny,state.zoom); renderAll()});
window.addEventListener('mouseup',()=>dragging=false);
mapEl.addEventListener('wheel',e=>{e.preventDefault(); setZoom(state.zoom+(e.deltaY>0?-1:1));},{passive:false});
mapEl.addEventListener('dblclick',()=>setZoom(state.zoom+1));
mapEl.addEventListener('touchstart',e=>{if(e.touches.length===1){dragging=true; last={x:e.touches[0].clientX,y:e.touches[0].clientY}}},{passive:true});
mapEl.addEventListener('touchmove',e=>{if(!dragging||e.touches.length!==1) return; const t=e.touches[0]; const dx=t.clientX-last.x, dy=t.clientY-last.y; last={x:t.clientX,y:t.clientY}; const c=project(state.center.lat,state.center.lng,state.zoom); const nx=c.x-dx, ny=c.y-dy; state.center=unproject(nx,ny,state.zoom); renderAll()},{passive:true});
mapEl.addEventListener('touchend',()=>dragging=false,{passive:true});
$('#zin').onclick=()=>setZoom(state.zoom+1); $('#zout').onclick=()=>setZoom(state.zoom-1);
function setZoom(z){const nz=Math.min(18,Math.max(3,Math.round(z))); if(nz!==state.zoom){state.zoom=nz; renderAll();}}

const R=6371; function hav(a,b){const dLat=(b.lat-a.lat)*Math.PI/180,dLng=(b.lng-a.lng)*Math.PI/180; const s=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.min(1,Math.sqrt(s)));}
function formatKm(km){return km<1?Math.round(km*1000)+' m':km.toFixed(1)+' km'}
function etaForDist(km){return km/state.speedKmh*60}
function lineInterpolate(a,b,n=96){const pts=[]; for(let i=0;i<=n;i++){const t=i/n; pts.push({lat:a.lat+(b.lat-a.lat)*t,lng:a.lng+(b.lng-a.lng)*t});} return pts}
function pointSegDist(p,a,b){const A={x:a.lng,y:a.lat},B={x:b.lng-a.lng,y:b.lat-a.lat}; const AP={x:p.lng-a.lng,y:p.lat-a.lat}; const t=Math.max(0,Math.min(1,(AP.x*B.x+AP.y*B.y)/(B.x*B.x+B.y*B.y))); const Q={lat:a.lat+t*(b.lat-a.lat),lng:a.lng+t*(b.lng-a.lng)}; const d=hav(p,Q); return{d,t,Q}}
function progressOnRoute(p){if(!state.route) return 0; let best={i:0,t:0,d:1e9}; let acc=0, prog=0; const poly=state.route.polyline; for(let i=1;i<poly.length;i++){const seg=pointSegDist(p,poly[i-1],poly[i]); if(seg.d<best.d){best={i,t:seg.t,d:seg.d}; prog=acc+hav(poly[i-1],poly[i])*seg.t;} acc+=hav(poly[i-1],poly[i]); } return prog}

function predictAvailability(spot,arrive){const arrTime=arrive.getTime(); const reports=state.reports.filter(r=>r.spot_id===spot.id); if(!reports.length) return 50; let wsum=0,vs=0; reports.forEach(r=>{const ageH=(arrTime-new Date(r.timestampISO).getTime())/3600000; if(ageH>48)return; const w=Math.exp(-ageH/6)*(0.5+(r.reputation||.5)); const val=r.status==='empty'?1:r.status==='some'?0.5:0; vs+=val*w; wsum+=w;}); let pct=wsum?Math.round(100*vs/wsum):50; const h=arrive.getHours(); if(h>=22||h<5)pct=Math.min(100,pct+15); if(h>=17&&h<21)pct=Math.max(0,pct-15); return Math.max(0,Math.min(100,pct));}
function classByPct(p){return p>=66?'mok':p>=33?'mwr':'mbd'}

function planRoute(){const start=state.pos||state.center; const dest=parseDest($('#dest').value)||{lat:48.998,lng:8.4}; const path=lineInterpolate(start,dest,96); state.route={start,dest,polyline:path}; showToast('Route gesetzt.'); renderAll(); computeAlong(); $('#sheet').classList.add('open');}
function parseDest(t){if(!t) return null; const m=t.match(/(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/); if(m) return {lat:+m[1],lng:+m[2]}; return geoMock(t.trim());}
function geoMock(txt){if(!txt) return null; const hash=[...txt].reduce((a,c)=>a+c.charCodeAt(0),0); const lat=48.3+(hash%100)/300, lng=7.7+((hash>>3)%100)/200; return {lat,lng}}
function drawRoute(){polyEl.innerHTML=''; if(!state.route)return; const {width,height}=mapEl.getBoundingClientRect(); const z=state.zoom; const c=project(state.center.lat,state.center.lng,z); const tlx=c.x-width/2,tly=c.y-height/2; const pts=state.route.polyline.map(p=>project(p.lat,p.lng,z)).map(p=>`${p.x-tlx},${p.y-tly}`).join(' '); const pl=document.createElementNS('http://www.w3.org/2000/svg','polyline'); pl.setAttribute('points',pts); pl.setAttribute('fill','none'); pl.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--primary')); pl.setAttribute('stroke-width','3'); pl.setAttribute('stroke-linejoin','round'); polyEl.appendChild(pl);}

function spotVisible(s){if(state.filters.maxH && s.max_height && s.max_height<state.filters.maxH) return false; if(s.security_level<state.filters.minSec) return false; if(state.filters.fac.size){for(const f of state.filters.fac){if(!s.facilities.includes(f)) return false;}} if(state.filters.onlyRoute && state.route){if(!nearRoute(s,2)) return false;} return true}
function nearRoute(s,km=2){if(!state.route) return false; let min=1e9; const poly=state.route.polyline; for(let i=1;i<poly.length;i++){const d=pointSegDist({lat:s.lat,lng:s.lng},poly[i-1],poly[i]).d; if(d<min) min=d;} return min<=km}
function markerColor(p){return p>=66?"#10b981":p>=33?"#f59e0b":"#ef4444"}
function renderMarkers(){overlayEl.innerHTML=''; const {width,height}=mapEl.getBoundingClientRect(); const z=state.zoom; const c=project(state.center.lat,state.center.lng,z); const tlx=c.x-width/2,tly=c.y-height/2; const visible=SPOTS.filter(spotVisible);
const items=visible.map(s=>{const p=project(s.lat,s.lng,z); const eta=state.route?etaAtPoint({lat:s.lat,lng:s.lng}):new Date(); const pct=predictAvailability(s,eta); return{sx:p.x-tlx,sy:p.y-tly,spot:s,pct,eta}});
if(z<12){const grid=60; const buckets=new Map(); items.forEach(it=>{const k=Math.round(it.sx/grid)+','+Math.round(it.sy/grid); const b=buckets.get(k)||[]; b.push(it); buckets.set(k,b)}); buckets.forEach(arr=>{if(arr.length===1){makeMarker(arr[0])}else{const x=arr.reduce((a,b)=>a+b.sx,0)/arr.length, y=arr.reduce((a,b)=>a+b.sy,0)/arr.length; const el=document.createElement('div'); el.className='marker mcl'; el.style.left=x+'px'; el.style.top=y+'px'; el.textContent=arr.length; overlayEl.appendChild(el)}});
}else items.forEach(makeMarker);
updateStats(items);
function makeMarker(it){const el=document.createElement('div'); el.className='marker '+classByPct(it.pct); el.style.left=it.sx+'px'; el.style.top=it.sy+'px'; el.style.background=markerColor(it.pct); el.textContent=Math.round(it.pct)+'%'; el.title=it.spot.name; el.tabIndex=0; el.onclick=()=>openPopup(it.spot,it.pct,it.eta); el.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){openPopup(it.spot,it.pct,it.eta)}}; overlayEl.appendChild(el)} }
function updateStats(items){const cnt=items.length; const avg=Math.round(items.reduce((a,b)=>a+b.pct,0)/Math.max(1,cnt)); $('#stats').textContent=`Sichtbare Spots: ${cnt} ¬∑ √ò Prognose: ${isFinite(avg)?avg:'‚Äì'}%`;}
function etaAtPoint(p){if(!state.route){return new Date()} const d=hav(state.route.start,p); const min=etaForDist(road(d)); return new Date(Date.now()+min*60000)}

function openPopup(spot,pct,eta){let distLabel=''; let distVal=hav(state.center,spot); if(state.route){distVal=progressOnRoute(spot); distLabel='Entfernung ab Start (Stra√üe, gesch√§tzt)';} else {distLabel='Entfernung (Stra√üe, gesch√§tzt)'}
const reports=state.reports.filter(r=>r.spot_id===spot.id).sort((a,b)=>b.timestampISO.localeCompare(a.timestampISO)).slice(0,3).map(r=>`<div class='k'><span class='badge ${r.status==='empty'?'green':r.status==='some'?'yellow':'red'}'>${r.status}</span> <span class='k'>${new Date(r.timestampISO).toLocaleTimeString()}</span></div>`).join('');
const nav=`https://www.google.com/maps/dir/?api=1&destination=${spot.lat},${spot.lng}`;
$('#popup').innerHTML=`<div class='row' style='justify-content:space-between'><b>${spot.name}</b><button class='btn ghost' onclick=\"document.querySelector('#popup').style.display='none'\">‚úï</button></div>
<div class='kv'><span class='k'>Koord.:</span><span>${spot.lat.toFixed(4)}, ${spot.lng.toFixed(4)}</span><span class='k'>Security:</span><span>${spot.security_level}</span><span class='k'>MaxH:</span><span>${spot.max_height||'‚Äì'} m</span><span class='k'>${distLabel}:</span><span>${formatKm(road(distVal))}</span></div>
<div class='fac row'>${spot.facilities.map(f=>SVGs[f]).join('')}</div>
<div class='row'><span class='badge ${pct>=66?'green':pct>=33?'yellow':'red'}'>Prognose bei Ankunft: ${pct}%</span><span class='k'>ETA: ${eta.toLocaleTimeString()}</span></div>
<div class='row'><a class='btn' href='${nav}' target='_blank' rel='noreferrer'>Navigieren</a><button class='btn sec' id='reportBtn'>Report abgeben</button></div>
<div class='stat'>Letzte Meldungen</div>${reports||'<div class="k">Keine</div>'}`;
$('#popup').style.display='block'; $('#reportBtn').onclick=()=>openReport(spot.id);} 
function openReport(spot_id){const host=$('#popup'); const box=document.createElement('div'); box.innerHTML=`<hr/><div class='row'><label><input type='radio' name='rs' value='empty' checked> Leer</label><label><input type='radio' name='rs' value='some'> Teilweise</label><label><input type='radio' name='rs' value='full'> Voll</label></div><textarea id='rnote' rows='2' style='width:100%;background:var(--bg);border:1px solid var(--line);border-radius:.6rem' placeholder='Notiz (optional)'></textarea><div class='row' style='justify-content:flex-end'><button class='btn' id='rsubmit'>Senden</button></div>`; host.appendChild(box); $('#rsubmit').onclick=()=>{const status=host.querySelector("input[name='rs']:checked").value; submitReport({spot_id,status,note:$('#rnote').value}); box.remove();};}
function submitReport(rep){const now=new Date().toISOString(); const item={spot_id:rep.spot_id,timestampISO:now,status:rep.status,reputation:.5,note:rep.note||''}; const last=state.reports.filter(r=>r.spot_id===rep.spot_id).sort((a,b)=>b.timestampISO.localeCompare(a.timestampISO))[0]; if(last && (new Date(now)-new Date(last.timestampISO)<5*60000)){showToast('Bitte warte 5 Minuten.'); return}
state.reports.push(item); try{const cur=JSON.parse(localStorage.getItem('tr_reports')||'[]'); cur.push(item); localStorage.setItem('tr_reports',JSON.stringify(cur));}catch{}
fetch(API,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(item)}).catch(()=>{});
showToast('Danke f√ºr die Meldung!'); renderAll();}

function computeAlong(){if(!state.route){$('#toplist').innerHTML='<div class=k>Keine Route</div>'; return} const arr=SPOTS.filter(s=>spotVisible(s)&&nearRoute(s,2)).map(s=>{const detour=hav(s,state.route.start)+hav(s,state.route.dest)-hav(state.route.start,state.route.dest); const eta=etaAtPoint(s); const pct=predictAvailability(s,eta); return{spot:s,detour:road(detour),pct,eta}}).sort((a,b)=>b.pct-a.pct||a.detour-b.detour);
const top=state.fullList?arr:arr.slice(0,3);
$('#toplist').innerHTML=(top.length?top:`<div class=k>${arr.length?'Keine Top‚ÄëSpots':'Keine Spots an der Route'}</div>`).map(o=>`<div class='item'><div><b>${o.spot.name}</b><div class='k'>Umweg ${formatKm(o.detour)} ¬∑ ETA ${o.eta.toLocaleTimeString()}</div><div>${o.spot.facilities.map(f=>`<span class='badge'>${f}</span>`).join(' ')}</div></div><div><span class='badge ${o.pct>=66?'green':o.pct>=33?'yellow':'red'}'>${o.pct}%</span></div></div>`).join('');}

function renderAll(){renderTiles(); drawRoute(); renderMarkers();}

$('#menu').onclick=()=>$('#sidebar').classList.toggle('open');
$('#theme').onclick=()=>{const d=document.documentElement; d.setAttribute('data-theme', d.getAttribute('data-theme')==='dark'?'light':'dark')}
$('#plan').onclick=planRoute;
$('#along').onclick=()=>{if(!state.route) planRoute(); state.filters.onlyRoute=true; $('#onlyRoute').checked=true; computeAlong(); $('#sheet').classList.add('open'); renderAll();};
$('#fH').oninput=e=>{state.filters.maxH=+e.target.value; renderAll(); computeAlong()};
$('#fS').oninput=e=>{state.filters.minSec=+e.target.value; renderAll(); computeAlong()};
$('#onlyRoute').onchange=e=>{state.filters.onlyRoute=e.target.checked; renderAll(); computeAlong()}
$('#tH').onchange=e=>state.truck.h=+e.target.value; $('#tW').onchange=e=>state.truck.w=+e.target.value; $('#tADR').onchange=e=>state.truck.adr=e.target.checked;
$('#more').onclick=()=>{state.fullList=!state.fullList; $('#sheet').classList.toggle('open',true); computeAlong();}

if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{state.pos={lat:p.coords.latitude,lng:p.coords.longitude}; state.center=state.pos; renderAll(); computeAlong();},{},{enableHighAccuracy:true,timeout:3000})}
setInterval(()=>{if(!state.pos)return; const near=SPOTS.find(s=>hav(s,state.pos)<0.2); if(near && Math.random()<.1){state.reports.push({spot_id:near.id,timestampISO:new Date().toISOString(),status:Math.random()<.5?'full':'empty',reputation:.6}); renderAll();}},15000);

let tDur=0,tEnd=0,tInt=null; $$('[data-tpreset]').forEach(b=>b.onclick=()=>{tDur=+b.dataset.tpreset*60; $('#tleft').textContent=Math.floor(tDur/60)+':00'});
$('#tstart').onclick=()=>{if(!tDur){tDur=45*60} tEnd=Date.now()+tDur*1000; clearInterval(tInt); tInt=setInterval(()=>{const left=Math.max(0,Math.round((tEnd-Date.now())/1000)); $('#tleft').textContent=`${Math.floor(left/60)}:${(left%60+'').padStart(2,'0')}`; if(left<=0){clearInterval(tInt); showToast('Pause vorbei!'); try{Notification.requestPermission().then(p=>{if(p==='granted') new Notification('TruckRadar',{body:'Pause vorbei!'});});}catch{}} },1000)};
$('#tstop').onclick=()=>{clearInterval(tInt)}; $('#treset').onclick=()=>{clearInterval(tInt); tDur=0; $('#tleft').textContent='‚Äì:‚Äì'};
let toT=null; function showToast(msg){const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toT); toT=setTimeout(()=>t.style.display='none',2500)}
window.addEventListener('resize',renderAll); renderAll();
})();
</script>
</body>
</html>
